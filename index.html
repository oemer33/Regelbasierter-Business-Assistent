<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ProQnA – Regelbasierter Assistent</title>
<style>
  :root { --bg:#f7f7f8; --fg:#0b0b0c; --muted:#6b7280; --card:#ffffff; --bord:#e5e7eb; --acc:#111; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--fg);background:var(--bg)}
  .wrap{min-height:100%;display:grid;place-items:center;padding:20px}
  .card{width:100%;max-width:900px;background:var(--card);border:1px solid var(--bord);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:18px 18px 22px}
  .header{display:flex;align-items:center;gap:14px;justify-content:space-between;flex-wrap:wrap}
  .title{font-size:22px;font-weight:800;letter-spacing:.2px}
  .brand{display:flex;align-items:center;gap:10px}
  .brand input{border:1px solid var(--bord);border-radius:12px;padding:8px 10px;min-width:240px}
  .muted{color:var(--muted);font-size:12px}
  .grid{display:grid;gap:14px}
  @media(min-width:900px){ .grid{grid-template-columns: 1.15fr .85fr} }
  .panel{background:#fafafa;border:1px solid var(--bord);border-radius:14px;padding:14px}
  label{display:block;font-size:12px;color:#374151;margin-bottom:6px}
  input[type=text], textarea{width:100%;border:1px solid var(--bord);border-radius:12px;padding:10px 12px;background:#fff}
  textarea{min-height:72px;resize:vertical}
  .mic-wrap{display:grid;place-items:center;margin:10px 0}
  .circle{width:110px;height:110px;border-radius:50%;display:grid;place-items:center;border:2px solid var(--bord);background:#fff;cursor:pointer;transition:transform .06s ease, background .2s ease, border-color .2s ease}
  .circle:hover{transform:translateY(-1px)}
  .circle.active{background:var(--acc);color:#fff;border-color:var(--acc);animation:pulse 1.4s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(17,17,17,.25)}70%{box-shadow:0 0 0 22px rgba(17,17,17,0)}100%{box-shadow:0 0 0 0 rgba(17,17,17,0)}}
  .status{text-align:center;font-size:12px;color:var(--muted);margin-top:6px}
  .log{background:#fff;border:1px solid var(--bord);border-radius:12px;padding:10px;height:220px;overflow:auto;font-size:13px;white-space:pre-wrap}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .btn{appearance:none;border:1px solid var(--acc);background:var(--acc);color:#fff;border-radius:999px;padding:9px 14px;font-size:14px;cursor:pointer}
  .btn.ghost{background:#fff;color:var(--acc)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .badges{display:flex;gap:6px;flex-wrap:wrap}
  .badge{background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;border-radius:999px;padding:4px 8px;font-size:12px}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:6px}
  .kpi .panel{padding:10px;text-align:center}
  .hl{background:#f0fdf4;border-color:#dcfce7}
  .footer{margin-top:10px;text-align:center;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <div class="title">ProQnA – Regelbasierter Fragen‑Beantworter</div>
      <div class="brand">
        <input id="bizName" value="Salon Beispiel"/>
        <span class="muted">Firmenname</span>
      </div>
    </div>

    <div class="grid" style="margin-top:12px;">
      <!-- Left: Console -->
      <div class="panel">
        <div class="mic-wrap">
          <div class="circle" id="mic">
            <svg width="42" height="42" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3z"></path>
              <path d="M19 11a1 1 0 1 0-2 0 5 5 0 0 1-10 0 1 1 0 1 0-2 0 7.002 7.002 0 0 0 6 6.92V21H8a1 1 0 1 0 0 2h8a1 1 0 1 0 0-2h-3v-3.08A7.002 7.002 0 0 0 19 11z"></path>
            </svg>
          </div>
          <div class="status" id="status">Klicken, um zu sprechen (Mikrofon zulassen) • oder unten tippen</div>
        </div>

        <div class="badges">
          <div class="badge" id="modeBadge">Modus: Regelbasiert</div>
          <div class="badge">Sprache: Deutsch</div>
          <div class="badge">Kein API‑Key erforderlich</div>
        </div>

        <div style="margin-top:8px">
          <label>Konsole / Transkript</label>
          <div class="log" id="log"></div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>Nachricht eingeben (Enter zum Senden)</label>
            <input type="text" id="manual" placeholder="z. B. 'Wann habt ihr offen?' oder 'Preis für Haarschnitt?'"/>
          </div>
          <div>
            <label>Erfasster Lead (Name • Wunschzeit • Telefon)</label>
            <input type="text" id="leadFields" placeholder="Max Mustermann • Mittwoch 14 Uhr • 0157 1234567"/>
          </div>
        </div>

        <div class="toolbar" style="margin-top:10px">
          <button class="btn" id="mailto">Lead per E‑Mail weiterleiten</button>
          <button class="btn ghost" id="exportTxt">Transkript exportieren (TXT)</button>
          <button class="btn ghost" id="exportCsv">Analytics exportieren (CSV)</button>
          <button class="btn ghost" id="reset">Zurücksetzen</button>
        </div>

        <div class="kpi">
          <div class="panel"><div class="muted">Treffer‑Intent</div><div id="kpi-intent" style="font-weight:700">–</div></div>
          <div class="panel"><div class="muted">Score</div><div id="kpi-score" style="font-weight:700">0</div></div>
          <div class="panel"><div class="muted">Ambiguität</div><div id="kpi-amb" style="font-weight:700">–</div></div>
          <div class="panel"><div class="muted">Gespräche</div><div id="kpi-turns" style="font-weight:700">0</div></div>
        </div>
      </div>

      <!-- Right: Knowledge & Settings -->
      <div class="panel">
        <label>Öffnungszeiten</label>
        <textarea id="hours">Mo–Fr 09:00–18:00, Sa 09:00–14:00, So geschlossen</textarea>

        <label style="margin-top:8px">Preise/Leistungen (Kurzinfo)</label>
        <textarea id="prices">Haarschnitt ab 25 €, Farbe ab 45 €, Kinder 15 €</textarea>

        <label style="margin-top:8px">Kontakt E‑Mail für Leads</label>
        <input type="text" id="leadEmail" value="kontakt@salon-beispiel.de"/>

        <label style="margin-top:10px">FAQ‑Konfiguration (JSON) – live editierbar</label>
        <textarea id="config" style="min-height:220px"></textarea>

        <div class="toolbar" style="margin-top:8px">
          <button class="btn" id="saveCfg">Speichern</button>
          <button class="btn ghost" id="loadCfg">Standard laden</button>
          <button class="btn ghost" id="importCfg">Importieren (JSON)</button>
          <button class="btn ghost" id="exportCfg">Exportieren (JSON)</button>
        </div>
        <div class="footer">Konfig & Branding werden lokal gespeichert (localStorage).</div>
      </div>
    </div>
  </div>
</div>

<script>
// -------------------- Utilities --------------------
const el = (id)=>document.getElementById(id);
const logEl = el('log');
const now = ()=> new Date().toLocaleString('de-DE');
const say = (text)=>{ try{ speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(text); u.lang='de-DE'; speechSynthesis.speak(u);}catch{} };
const logSys = (t)=>{ logEl.textContent += `[${now()}] Assistent: ${t}\n`; logEl.scrollTop=logEl.scrollHeight; };
const logUser= (t)=>{ logEl.textContent += `[${now()}] Kunde: ${t}\n`; logEl.scrollTop=logEl.scrollHeight; };

const KPI = {
  intent: el('kpi-intent'),
  score: el('kpi-score'),
  amb: el('kpi-amb'),
  turns: el('kpi-turns'),
};
let turns=0;

// Levenshtein‑Distanz (für fuzzy matching)
function levenshtein(a,b){
  a = a || ''; b = b || '';
  const m = a.length, n = b.length;
  if (!m) return n; if (!n) return m;
  const dp = Array.from({length:m+1}, ()=>Array(n+1).fill(0));
  for (let i=0;i<=m;i++) dp[i][0]=i;
  for (let j=0;j<=n;j++) dp[0][j]=j;
  for (let i=1;i<=m;i++){
    for (let j=1;j<=n;j++){
      const cost = a[i-1]===b[j-1] ? 0 : 1;
      dp[i][j] = Math.min(
        dp[i-1][j] + 1,
        dp[i][j-1] + 1,
        dp[i-1][j-1] + cost
      );
    }
  }
  return dp[m][n];
}

const STOP = new Set(("aber alle allen allem allen aller alles als also am an ander andere anderem anderen anderer anderes auch auf aus bei bin bist da damit dann das dass dein deine dem den der des deshalb die dies dieser dieses doch dort du durch ein eine einem einen einer eines er es fast finden für ganz gegen geht geht's gern gerade gleich groß gut habe haben hat hatte hatten hier ich ihr ihre im immer in ist ihr ihm ihn ja je jetzt kann kein kleine klein kommt könnten leicht leider mach machen mal man mehr mein meine mit müssen nach nicht noch nur nun oder per sehr sein seine seit sie sind so sofort soll sollen sonst spater spät statt tun über um und uns unser unter viel vom von vor wann war waren warum was wegen weil weiter welche welcher welches wenn wer wird wirst wo wohl wollen wollte wünschen z.b. zwischen").split(' '));

// Synonyme (erweiterbar)
const SYN = {
  'öffnungszeiten': ['zeiten','geöffnet','auf','wann offen','business hours','hours'],
  'preise': ['kosten','tarif','gebühr','preis','kostenpunkt'],
  'termin': ['buchen','reservieren','anmeldung','appointment','booking'],
  'telefon': ['anrufen','telefonnummer','nummer','call'],
  'adresse': ['standort','wo','anschrift','addresse','adresse','map','karte'],
};

function normalize(text){
  return (text||'').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // diacritics off
    .replace(/[^a-z0-9äöüß\s\-]/gi,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function tokens(text){
  const toks = normalize(text).split(' ').filter(Boolean).filter(t=>!STOP.has(t));
  // synonyms expansion
  let expanded = [];
  for (const t of toks){
    expanded.push(t);
    for (const [base, arr] of Object.entries(SYN)){
      if (t===base || arr.includes(t)) expanded.push(base);
    }
  }
  return expanded;
}

// -------------------- Knowledge / Config --------------------
const DEFAULT_CFG = {
  intents: [
    {
      id: "hours",
      title: "Öffnungszeiten",
      answerTpl: ()=> `Unsere Öffnungszeiten sind: ${el('hours').value}. Kann ich sonst noch helfen?`,
      keywords: ["öffnungszeiten","zeiten","geöffnet","wann","uhr"],
      regex: ["\\b(öffnungs|zeiten|wann|geöffnet)\\b"]
    },
    {
      id: "prices",
      title: "Preise",
      answerTpl: ()=> `Unsere Preise/Leistungen: ${el('prices').value}. Möchten Sie einen Termin anfragen?`,
      keywords: ["preise","kosten","tarif","gebühr","preis"],
      regex: ["\\b(preis|preise|kosten|gebühr|tarif)\\b"]
    },
    {
      id: "booking",
      title: "Termin",
      answerTpl: ()=> "Gern. Nennen Sie mir bitte Ihren Namen, eine Wunschzeit und optional Ihre Telefonnummer.",
      keywords: ["termin","buchen","reservieren","appointment","booking"],
      regex: ["\\b(termin|buchen|reservieren)\\b"],
      slots: ["name","zeit","telefon"]
    },
    {
      id: "phone",
      title: "Telefon",
      answerTpl: ()=> "Sie erreichen uns telefonisch unter: (bitte Nummer im Antworttext ergänzen).",
      keywords: ["telefon","anrufen","nummer","call"],
      regex: ["\\b(telefon|nummer|anrufen)\\b"]
    },
    {
      id: "address",
      title: "Adresse",
      answerTpl: ()=> "Unsere Adresse lautet: (bitte Adresse ergänzen). Wir freuen uns auf Ihren Besuch!",
      keywords: ["adresse","standort","anschrift","wo"],
      regex: ["\\b(adresse|standort|anschrift|wo)\\b"]
    },
    {
      id: "greeting",
      title: "Begrüßung",
      answerTpl: ()=> `Willkommen bei ${el('bizName').value}. Wobei kann ich helfen – Öffnungszeiten, Preise oder ein Termin?`,
      keywords: ["hallo","hi","guten","moin","servus"],
      regex: ["\\b(hallo|hi|guten tag|moin|servus)\\b"]
    },
    {
      id: "bye",
      title: "Verabschiedung",
      answerTpl: ()=> "Vielen Dank! Einen schönen Tag noch!",
      keywords: ["danke","tschüss","ciao","auf wiedersehen"],
      regex: ["\\b(danke|tschüss|auf wiedersehen|ciao)\\b"]
    }
  ],
  threshold: 0.55,
  clarifyTopK: 3
};

function loadConfig(){
  const raw = localStorage.getItem('proqna_cfg');
  return raw ? JSON.parse(raw) : DEFAULT_CFG;
}
function saveConfig(cfg){
  localStorage.setItem('proqna_cfg', JSON.stringify(cfg));
}

// -------------------- Matching Engine --------------------
function scoreIntent(intent, text){
  let score = 0;
  const toks = tokens(text);
  // keyword hits
  for (const kw of (intent.keywords||[])){
    for (const t of toks){
      if (t===kw) score += 1.0;
      else {
        const d = levenshtein(t, kw);
        const sim = 1 - (d / Math.max(t.length, kw.length));
        if (sim >= 0.78) score += 0.5; // fuzzy
      }
    }
  }
  // regex hits
  for (const rx of (intent.regex||[])){
    try{
      const re = new RegExp(rx,'i');
      if (re.test(text)) score += 2.0;
    }catch{}
  }
  // phrase closeness (questions variants)
  if (intent.questions){
    for (const q of intent.questions){
      const d = levenshtein(normalize(text), normalize(q));
      const sim = 1 - (d / Math.max(text.length, q.length));
      if (sim >= 0.7) score += 1.2;
    }
  }
  return score;
}

function bestIntents(cfg, text){
  const ranked = cfg.intents.map(it=>({ id:it.id, title:it.title, score:scoreIntent(it, text), ref:it }))
    .sort((a,b)=> b.score - a.score);
  return ranked;
}

// -------------------- Runtime --------------------
const mic = el('mic');
const statusEl = el('status');
const manual = el('manual');
const leadFields = el('leadFields');
const leadEmail = el('leadEmail');
const bizName = el('bizName');

// Speech
const SR = window.SpeechRecognition || window.webkitSpeechRecognition || null;
let rec=null, listening=false;

function toggleListen(){
  if (!SR){
    statusEl.textContent = 'Kein SpeechRecognition – bitte tippen.';
    mic.classList.toggle('active'); setTimeout(()=>mic.classList.remove('active'), 260);
    return;
  }
  if (!rec){
    rec = new SR(); rec.lang='de-DE'; rec.continuous=true; rec.interimResults=true;
    rec.onresult = (e)=>{
      let finalText='';
      for (let i=e.resultIndex;i<e.results.length;i++){
        const r=e.results[i];
        if (r.isFinal) finalText += r[0].transcript + ' ';
      }
      finalText = finalText.trim();
      if (finalText) handleUser(finalText);
    };
    rec.onend = ()=>{ listening=false; mic.classList.remove('active'); statusEl.textContent='Klicken, um zu sprechen (Mikro zulassen)'; };
  }
  if (!listening){
    try{ rec.start(); listening=true; mic.classList.add('active'); statusEl.textContent='Zuhören … sprechen Sie jetzt'; greet(); }catch{ statusEl.textContent='Mikro verweigert oder Fehler'; }
  } else {
    try{ rec.stop(); }catch{}
  }
}

mic.addEventListener('click', toggleListen);
manual.addEventListener('keydown', (e)=>{
  if (e.key==='Enter'){
    const t = manual.value.trim();
    manual.value='';
    if (t) handleUser(t);
  }
});

function greet(){
  const cfg = loadConfig();
  const g = cfg.intents.find(x=>x.id==='greeting');
  const out = g ? g.answerTpl() : `Willkommen bei ${bizName.value}. Wie kann ich helfen?`;
  logSys(out); say(out);
}

function extractLead(text){
  const parts = leadFields.value.split('•').map(s=>s.trim());
  let name = parts[0]||'', time = parts[1]||'', phone = parts[2]||'';
  const nameMatch = text.match(/(?:ich heiße|mein name(?: ist)?|name ist)\\s+([A-Za-zÄÖÜäöüß\\- ]{2,})/i);
  if (nameMatch) name = nameMatch[1].trim();
  const telMatch = text.match(/(\\+?\\d[\\d\\s\\/\\-]{5,}\\d)/);
  if (telMatch) phone = telMatch[1].replace(/\\s+/g,' ').trim();
  if (/(heute|morgen|montag|dienstag|mittwoch|donnerstag|freitag|samstag|sonntag|uhr|:\\d{2})/i.test(text)) time = text;
  leadFields.value = [name,time,phone].filter(Boolean).join(' • ');
}

function clarify(candidates){
  const q = 'Meinten Sie: ' + candidates.map(c=>c.title).slice(0,3).join(' / ') + ' ?';
  KPI.amb.textContent = candidates.map(c=>c.title).slice(0,3).join(', ');
  logSys(q); say(q);
}

function respond(intent){
  const out = intent.answerTpl();
  KPI.intent.textContent = intent.title;
  KPI.score.textContent = Number(intent.__score||0).toFixed(2);
  KPI.amb.textContent = '–';
  logSys(out); say(out);
}

function handleUser(text){
  turns++; KPI.turns.textContent = String(turns);
  logUser(text);
  extractLead(text);
  const cfg = loadConfig();
  const ranked = bestIntents(cfg, text);
  ranked.forEach((r,i)=> r.ref.__score = r.score);

  const top = ranked[0];
  const top2 = ranked[1];
  const thr = cfg.threshold || 0.55;

  if (!top || top.score < thr){
    clarify(ranked.slice(0, cfg.clarifyTopK || 3));
    return;
  }
  // Ambiguity check
  if (top2 && (top.score - top2.score) < 0.5){
    clarify(ranked.slice(0, cfg.clarifyTopK || 3));
    return;
  }
  respond(top.ref);
}

// --------------- Mail / Export / Analytics ---------------
el('mailto').addEventListener('click', ()=>{
  const subject = encodeURIComponent(`Anfrage von digitaler Assistenz – ${bizName.value}`);
  const body = encodeURIComponent(
    `Hallo ${bizName.value},\n\n`+
    `Neue Anfrage:\n`+
    `Lead: ${el('leadFields').value || '(keine Daten)'}\n\n`+
    `Transkript (Auszug):\n${logEl.textContent.slice(-1800)}\n\n`+
    `Viele Grüße\nProQnA Assistent`
  );
  const target = el('leadEmail').value || 'info@example.com';
  window.location.href = `mailto:${target}?subject=${subject}&body=${body}`;
});

el('exportTxt').addEventListener('click', ()=>{
  const blob = new Blob([logEl.textContent], {type:'text/plain;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='transkript.txt'; a.click(); URL.revokeObjectURL(url);
});

el('exportCsv').addEventListener('click', ()=>{
  const rows = [['Zeit','Typ','Text']];
  const lines = logEl.textContent.split('\n').filter(Boolean);
  for (const line of lines){
    const m = line.match(/^\[(.*?)\]\s(Assistent|Kunde):\s(.*)$/);
    if (m) rows.push([m[1], m[2], m[3].replace(/"/g,'""')]);
  }
  const csv = rows.map(r=> r.map(x=>`"${x}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='analytics.csv'; a.click(); URL.revokeObjectURL(url);
});

el('reset').addEventListener('click', ()=>{
  logEl.textContent='';
  el('leadFields').value='';
  turns=0; KPI.turns.textContent='0'; KPI.intent.textContent='–'; KPI.score.textContent='0'; KPI.amb.textContent='–';
  greet();
});

// --------------- Config area ---------------
const cfgArea = el('config');
function refreshCfgArea(){ cfgArea.value = JSON.stringify(loadConfig(), null, 2); }
el('saveCfg').addEventListener('click', ()=>{
  try{ const cfg = JSON.parse(cfgArea.value); saveConfig(cfg); logSys('Konfiguration gespeichert.'); }catch{ alert('Ungültiges JSON'); }
});
el('loadCfg').addEventListener('click', ()=>{ saveConfig(DEFAULT_CFG); refreshCfgArea(); logSys('Standardkonfiguration geladen.'); });
el('exportCfg').addEventListener('click', ()=>{
  const blob = new Blob([cfgArea.value], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='proqna_config.json'; a.click(); URL.revokeObjectURL(url);
});
el('importCfg').addEventListener('click', ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = ()=>{
    const f = inp.files[0]; if (!f) return;
    const fr = new FileReader();
    fr.onload = ()=>{ try{ const data = JSON.parse(fr.result); saveConfig(data); refreshCfgArea(); logSys('Konfiguration importiert.'); }catch{ alert('Ungültige JSON-Datei.'); } };
    fr.readAsText(f, 'utf-8');
  };
  inp.click();
});

// --------------- Init ---------------
(function init(){
  refreshCfgArea();
  logSys('ProQnA gestartet. Fragen Sie z. B. nach Öffnungszeiten, Preisen oder einem Termin.');
})();
</script>
</body>
</html>
